---
title: "Technical Appendix"
author: "Antonio Skilton"
output:
  md_document:
    variant: markdown_github
  output: html_notebook
---

##The Data

####The election data
The data I am using is from US Election Atlas, which sells proprietary data. As a result, I will not include their entire dataset here. Instead, I will only include a variable that represents the vote difference between the candidates on a county level.
```{r, echo=T, message=F, warning=FALSE}
library(tidyverse)
```

```{r, message=F, warning=F, eval=T}
election <- read_csv("data/clean/Pres_Election_Data_2016i.csv", col_types = cols())
```

"Margin" represents the margin of victory with which Donald Trump won a particular county. A positive value corresponds to a Trump victory, a negative value corresponds to a Clinton victory.
```{r, echo = F}
election
```

```{r}
ggplot(election, aes(x = abs(vote_difference))) +
  geom_histogram() + 
  scale_x_continuous(labels = scales::percent) +
  labs(title = "Histogram of Absolute Margins",
       subtitle = "The majority of counties were not competitive",
       x = "Absolute margin between Trump and Clinton") +
  theme_minimal()
```

```{r}
ggplot(election, aes(x = vote_difference, fill = victor)) +
  geom_histogram() + 
  scale_x_continuous(labels = scales::percent) +
  labs(title = "Histogram of Trump Margin of Victory",
       subtitle = "Most counties where Trump won were landslides. The opposite is true for Clinton.",
       x = "Trump margin of victory") +
  theme_minimal()
```


####Other county level data
There are county level datasets available for free from a variety of government sources. These were cleaned in R (HYPERLINK) then uploaded to SQL Server for further cleaning and data mining.

County Density:
```{r, message=F, warning=FALSE}
density <- read_csv("data/raw/county_density.csv", skip = 1, 
         col_types = cols_only(`Target Geo Id` = col_character(),
                               `Density per square mile of land area - Population` = col_double())) %>% 
  filter(nchar(`Target Geo Id`) == 14) %>% 
  transmute(STATEFIPS = as.numeric(substr(`Target Geo Id`, start = 10, stop = 11)),
            COUNTY = as.numeric(substr(`Target Geo Id`, start = 12, stop = 14)),
            people_per_sq_mile = `Density per square mile of land area - Population`)
```

```{r, echo=F, message=FALSE, warning=F}
density %>% 
  rename(`People per square mile` = people_per_sq_mile)
```


Affordable Care Act change in uninsured rates [from Enroll America](https://www.enrollamerica.org/research-maps/maps/changes-in-uninsured-rates-by-county/):
```{r}
insurance <- read_csv("data/raw/County_Data_2016_health_insurance.csv",
         col_types = list(county_fips = col_character())) %>% 
  setNames(gsub(pattern = " ", replacement = "_", names(.))) %>% 
  transmute(STATEFIPS = ifelse(nchar(county_fips) == 5,
                               as.numeric(substr(county_fips, start = 1, stop = 2)),
                               as.numeric(substr(county_fips, start = 1, stop = 1))),
                               COUNTY = as.numeric(substr(county_fips, start = nchar(county_fips) - 2, stop = nchar(county_fips))),
                               uninsured_rate_2013 = `2013_uninsured_rate` / 100,
                               uninsured_rate_2016 = `2016_uninsured_rate` / 100,
                               decrease_from_2013_to_2016 = decrease_from_2013_to_2016 / 100) %>% 
  rename(change = decrease_from_2013_to_2016) %>% 
  arrange(STATEFIPS, COUNTY)
```

```{r, echo=F}
insurance %>% 
  rename(`Rate Uninsured in 2013` = uninsured_rate_2013,
         `Rate Uninsured in 2016` = uninsured_rate_2016)
```


Economic data from the [USDA](https://www.ers.usda.gov/topics/rural-economy-population/rural-classifications.aspx).

```{r}
econ <- read_csv("data/raw/Unemployment.csv", skip = 6, 
         col_types = cols_only(FIPS_Code = col_character(),
                               Unemployment_rate_2015 = col_double(),
                               Median_Household_Income_2014 = col_number())) %>% 
  transmute(STATEFIPS = as.numeric(substr(FIPS_Code, 1, 2)),
            COUNTY = as.numeric(substr(FIPS_Code, 3, 5)),
            Unemployment_rate_2015 = Unemployment_rate_2015 / 100,
            Median_Household_Income_2014) %>% 
  filter(COUNTY != 0) 
```
```{r, echo=F}
econ %>% 
  rename(`Unemployment rate in 2015` = Unemployment_rate_2015,
         `Median household income in 2014` = Median_Household_Income_2014)
```


County characteristics dataset from the [Census](https://www.census.gov/popest/data/counties/asrh/2015/CC-EST2015-ALLDATA.html):
```{r, message=FALSE, warning=FALSE}
NHWA <- read_csv("data/raw/CC-EST2015-ALLDATA.csv",
         col_types = cols_only(STATE = col_integer(),
                               COUNTY = col_integer(),
                               TOT_POP = col_integer(),
                               AGEGRP = col_integer(),
                               YEAR = col_integer(),
                               NHWA_MALE = col_integer(),
                               NHWA_FEMALE = col_integer()),
         progress = F) %>% 
  filter(AGEGRP >= 5,
         YEAR == 8) %>% 
  rename(STATEFIPS = STATE) %>%
  group_by(STATEFIPS, COUNTY) %>% 
  summarise(TOT_POP = sum(TOT_POP),
            NHWA = sum(NHWA_MALE + NHWA_FEMALE) / sum(TOT_POP))
```

```{r, echo=F}
NHWA %>% 
  rename(`Total Population (TOT_POP)` = TOT_POP,
         `Non-Hispanic White Alone (NHWA)` = NHWA)
```

Education data from 
```{r}
education <- read_csv("data/raw/Education.csv", skip = 4) %>%
  slice(-c(1,2)) %>% 
  select(`FIPS Code`, contains("Percent")) %>% 
  setNames(gsub(pattern = "[[:punct:]]| ", replacement = "_", names(.))) %>%
  setNames(gsub(pattern = "High_school_diploma", replacement = "HSD", names(.), ignore.case = T)) %>%
  setNames(gsub(pattern = "Some_college_or_associate_s_degree|some_college_", replacement = "someCollege", names(.), ignore.case = T)) %>%
  setNames(gsub(pattern = "bachelor_s_degree_or_higher", replacement = "bachelorsOrMore", names(.), ignore.case = T)) %>%
  setNames(gsub(pattern = "with_less_than_a_HSD_|less_than_a_HSD_", replacement = "lessThanHSD", names(.), ignore.case = T)) %>%
  setNames(gsub(pattern = "percent_of_", replacement = "", names(.), ignore.case = T)) %>%
  setNames(gsub(pattern = "___|__", replacement = "_", names(.))) %>%
  mutate(STATEFIPS = as.numeric(substr(FIPS_Code, 1, 2)),
         COUNTY = as.numeric(substr(FIPS_Code, 3, 5))) %>%
  select(STATEFIPS, COUNTY, -FIPS_Code, adults_lessThanHSD_1970:adults_with_a_bachelorsOrMore_2010_2014) %>% 
  gather(key, value, -STATEFIPS, -COUNTY) %>% 
  transmute(STATEFIPS, COUNTY, key, percent = value / 100,
            year = gsub('\\D','\\1', key),
            year = as.numeric(substr(year, nchar(year) - 3, nchar(year))),
            year = ifelse(year == 2014, 2010, year)) %>% 
  spread(key, percent, drop = FALSE) %>% 
  unite(someCollege, contains("someCollege")) %>% 
  unite(bachelorsOrMore, contains("bachelorsOrMore"), contains("four_years_of_college_or_higher")) %>% 
  unite(lessThanHSD, contains("lessThanHSD")) %>% 
  unite(HSDonly, contains("HSD_only")) %>% 
  mutate_at(vars(bachelorsOrMore:HSDonly), funs(as.numeric(gsub("NA|_", "", .)))) %>% 
  filter(COUNTY != 0)
```

```{r, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}
education %>% 
  na.omit() %>% 
  gather(key, value, bachelorsOrMore:HSDonly) %>% 
  mutate(key = plyr::mapvalues(key, 
                               from = c("bachelorsOrMore", "HSDonly", 
                                        "lessThanHSD", "someCollege"),
                               to = c("Bachelors Degree or More", "High School Degree Only",
                                      "Less Than High School", "Some College"))) %>% 
group_by(STATEFIPS, year, key) %>% 
  mutate(avgyear = mean(value)) %>% 
  arrange(STATEFIPS, year) %>% 
  group_by(STATEFIPS, key) %>% 
  transmute(COUNTY,
            year, 
            value,
            percent_growth = (last(avgyear) - first(avgyear)) / first(avgyear)) %>% 
  unite(state_county, STATEFIPS, COUNTY, remove = F) %>% 
  ggplot(aes(x = year, y = value, color = percent_growth, group = state_county)) +
  geom_line(alpha = 1/10) +
  theme(legend.position = "none") +
  facet_wrap(~key) + 
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() + 
  labs(title = "Percent of Population by Year",
       y = "Percent with Bachelors Degree or More")
```

I join these datasets:
```{r, message=FALSE, warning=FALSE}
joined_data <- election %>% 
  inner_join(density) %>% 
  inner_join(insurance) %>% 
  inner_join(econ) %>% 
  inner_join(NHWA)
```

```{r, echo=F, message=FALSE, warning=FALSE}
joined_data
```

```{r, fig.width=10}
joined_data %>%
  gather(key, value, people_per_sq_mile:NHWA) %>% 
  ggplot(aes(x = value)) +
    geom_histogram() +
    facet_wrap(~key, scales = "free") + 
    theme_minimal()
```

The "vote_difference" variable is of greatest interest here. The following correlations show us which variables are most related to the election outcomes per county.
```{r, fig.height=5}
library(antonioSkiltonTools)
library(forcats)

joined_data %>% 
  rankedCorrelations() %>% 
  filter(Vars1 == "vote_difference" | Vars2 == "vote_difference") %>% 
  unite(Vars, Vars1, Vars2, sep = " & ") %>% 
  arrange(abs(correlation)) %>% 
  mutate(Vars = fct_inorder(Vars)) %>% 
  ggplot(aes(x = Vars, y = correlation, alpha = log(abs(correlation)))) +
    geom_bar(stat = "identity") + 
    coord_flip() + 
    theme_minimal() +
    scale_y_continuous(labels = scales::percent, limits = c(-1,1)) +
    scale_alpha(guide = F) +
    labs(title = "Ranked Correlations",
         y = "Degree of correlation",
         x = "Variable pairs")
```

#Relationships
```{r, fig.width=10}
joined_data %>% 
  ggplot(aes(x = NHWA, y = vote_difference, size = TOT_POP, color = victor)) + 
    geom_point(alpha = 1/5) + 
    theme_minimal() +
    scale_color_brewer(type = "qual", palette = "Set1", direction = -1) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) + 
    scale_size(guide = F) +
    labs(title = "Counties by Trump Victory Margin and Whiteness",
         x = "Percent of county that is non-Hispanic White",
         y = "Margin of Trump lead")
```

```{r, fig.width=10, message=FALSE, warning=FALSE}
joined_data %>% 
  ggplot(aes(x = TOT_POP / 1000, fill = victor)) + 
    geom_histogram(bins = 75) + 
    facet_wrap(~victor, scales = "free_x") +
    theme_minimal() +
    scale_y_log10() +
    scale_fill_brewer(type = "qual", palette = "Set1", direction = -1) +
    labs(title = "Distribution of County Populations",
         subtitle = "Counties in which Trump tend to be smaller.",
         x = "Total population in thousands")
```

```{r, fig.width=10}
joined_data %>% 
  ggplot(aes(x = Unemployment_rate_2015, y = vote_difference, size = TOT_POP, color = victor)) + 
    geom_point(alpha = 1/5) + 
    facet_wrap(~cut(people_per_sq_mile, 
                    breaks = c(-Inf, 15, 300, Inf), 
                    labels= c("low density", "medium density", "high density")), scales = "free_x") +
    theme_minimal() +
    scale_color_brewer(type = "qual", palette = "Set1", direction = -1) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) + 
    scale_size(guide = F) +
    labs(title = "Counties by Trump Victory Margin and Whiteness",
         subtitle = "Low density counties are more White and more pro Trump",
         x = "Percent of county that is non-Hispanic White",
         y = "Margin of Trump lead")
```

To detect multicolinearity, we show correlations between independent variables.
```{r, fig.height=8}
joined_data %>% 
  rankedCorrelations() %>% 
  filter(Vars1 != "vote_difference" & Vars2 != "vote_difference") %>% 
  unite(Vars, Vars1, Vars2, sep = " & ") %>% 
  arrange(abs(correlation)) %>% 
  mutate(Vars = fct_inorder(Vars)) %>% 
  ggplot(aes(x = Vars, y = correlation, alpha = log(abs(correlation)))) +
    geom_bar(stat = "identity") + 
    coord_flip() + 
    theme_minimal() +
    scale_y_continuous(labels = scales::percent, limits = c(-1,1)) +
    scale_alpha(guide = F) +
    labs(title = "Ranked Correlations",
         y = "Degree of correlation",
         x = "Variable pairs")
```

```{r, fig.width=10}
joined_data %>% 
  ggplot(aes(x = Median_Household_Income_2014, y = uninsured_rate_2013, size = TOT_POP)) + 
    geom_point(alpha = 1/5) + 
    theme_minimal() +
    scale_x_continuous(labels = scales::dollar) + 
    scale_y_continuous(labels = scales::percent) +
    scale_size(guide = F)
```

#Random Forest Time
```{r, message=FALSE, warning=FALSE}
library(randomForest)
sample_data <- (joined_data)
data.rf <- randomForest(x = select(joined_data, -vote_difference, -victor),
                        y = joined_data$vote_difference,
                        importance = T)
imp <- importance(data.rf, 1)[order(importance(data.rf, 1), decreasing = T),] 
tibble(Variable = names(imp),`%Increase in MSE` = round(imp, 2) / 100)
```
